(()=>{var e={};e.id=24,e.ids=[24],e.modules={101:(e,t,r)=>{"use strict";r.d(t,{_4:()=>o,qF:()=>i});var s=r(97877);r(9365);let o=new s.A(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-05-28.basil"}),i={requires_payment_method:"pending",requires_confirmation:"pending",requires_action:"pending",processing:"pending",succeeded:"paid",canceled:"failed",requires_capture:"pending"}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},41506:(e,t,r)=>{"use strict";r.d(t,{N:()=>s});let s=(0,r(66437).UU)("https://ilkalkvghslckvmpkxbb.supabase.co/","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsa2Fsa3ZnaHNsY2t2bXBreGJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxNTYwNjEsImV4cCI6MjA2NTczMjA2MX0.w5c4TW1GsnCDKgFAGFabhbbt1X9pHqN8tzpvgBPsjEg")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63599:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>y,serverHooks:()=>h,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{POST:()=>d});var o=r(96559),i=r(48088),n=r(37719),a=r(32190),p=r(101),u=r(41506);async function d(e){let t,r=await e.text(),s=e.headers.get("stripe-signature");if(!s)return a.NextResponse.json({error:"Missing stripe-signature header"},{status:400});try{t=p._4.webhooks.constructEvent(r,s,process.env.STRIPE_WEBHOOK_SECRET||"whsec_test")}catch(e){return console.error("Webhook signature verification failed:",e),a.NextResponse.json({error:"Invalid signature"},{status:400})}try{switch(t.type){case"checkout.session.completed":await c(t.data.object);break;case"checkout.session.expired":await l(t.data.object);break;case"payment_intent.succeeded":case"payment_intent.payment_failed":case"payment_intent.canceled":case"payment_intent.requires_action":await m(t.data.object);break;default:console.log(`Unhandled event type: ${t.type}`)}return a.NextResponse.json({received:!0})}catch(e){return console.error("Error handling webhook:",e),a.NextResponse.json({error:"Webhook handler failed"},{status:500})}}async function c(e){let t=e.id,r=e.payment_status,s=e.payment_intent;console.log(`Checkout session completed: ${t}, status: ${r}`);let{data:o,error:i}=await u.N.from("payments").select("*").eq("reference",t).single();if(i||!o)return void console.error("Payment not found for checkout session:",t);let n="paid"===r?"paid":"failed",{error:a}=await u.N.from("payments").update({payment_status:n,payment_method:"card",notes:`Stripe Checkout Session completed: ${t}${s?` | Payment Intent: ${s}`:""}`,updated_at:new Date().toISOString()}).eq("id",o.id);if(a)return void console.error("Error updating payment status:",a);"paid"===n&&o.booking_id&&await u.N.from("bookings").update({payment_status:"paid",updated_at:new Date().toISOString()}).eq("id",o.booking_id),console.log(`Payment ${o.id} updated to status: ${n}`)}async function l(e){let t=e.id;console.log(`Checkout session expired: ${t}`);let{data:r,error:s}=await u.N.from("payments").select("*").eq("reference",t).single();if(s||!r)return void console.error("Payment not found for expired checkout session:",t);let{error:o}=await u.N.from("payments").update({payment_status:"failed",notes:`Stripe Checkout Session expired: ${t}`,updated_at:new Date().toISOString()}).eq("id",r.id);if(o)return void console.error("Error updating expired payment status:",o);console.log(`Payment ${r.id} marked as failed due to session expiration`)}async function m(e){let t=e.id,r=e.status,s=e.payment_method?.type||"card",{data:o,error:i}=await u.N.from("payments").select("*").eq("reference",t).single();if(i||!o)return void console.error("Payment not found for payment intent:",t);let n=p.qF[r]||"pending",{error:a}=await u.N.from("payments").update({payment_status:n,payment_method:s,updated_at:new Date().toISOString()}).eq("id",o.id);if(a)return void console.error("Error updating payment status:",a);"paid"===n&&o.booking_id&&await u.N.from("bookings").update({payment_status:"paid",updated_at:new Date().toISOString()}).eq("id",o.booking_id),console.log(`Payment ${o.id} updated to status: ${n}`)}let y=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/webhooks/stripe/route",pathname:"/api/webhooks/stripe",filename:"route",bundlePath:"app/api/webhooks/stripe/route"},resolvedPagePath:"/Users/ivanivanov/Documents/Projects/Plumbe-2/app/api/webhooks/stripe/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:f,serverHooks:h}=y;function x(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:f})}},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,928,449],()=>r(63599));module.exports=s})();