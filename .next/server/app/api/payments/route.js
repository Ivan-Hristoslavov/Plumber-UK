(()=>{var e={};e.id=131,e.ids=[131],e.modules={101:(e,t,r)=>{"use strict";r.d(t,{_4:()=>n,qF:()=>a});var s=r(97877);r(9365);let n=new s.A(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-05-28.basil"}),a={requires_payment_method:"pending",requires_confirmation:"pending",requires_action:"pending",processing:"pending",succeeded:"paid",canceled:"failed",requires_capture:"pending"}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},41506:(e,t,r)=>{"use strict";r.d(t,{N:()=>s});let s=(0,r(66437).UU)("https://ilkalkvghslckvmpkxbb.supabase.co/","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsa2Fsa3ZnaHNsY2t2bXBreGJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxNTYwNjEsImV4cCI6MjA2NTczMjA2MX0.w5c4TW1GsnCDKgFAGFabhbbt1X9pHqN8tzpvgBPsjEg")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},74292:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>m,serverHooks:()=>_,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>d,PUT:()=>l});var n=r(96559),a=r(48088),o=r(37719),i=r(32190),p=r(41506),u=r(101);async function c(){try{let{data:e,error:t}=await p.N.from("payments").select(`
        *,
        customers!inner(name, email),
        bookings(service, date, customer_name)
      `).order("created_at",{ascending:!1});if(t)return console.error("Error fetching payments:",t),i.NextResponse.json({error:"Failed to fetch payments"},{status:500});return i.NextResponse.json(e)}catch(e){return console.error("Unexpected error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function d(e){try{let{type:t,...r}=await e.json();if("create_payment_link"===t){let{customer_id:e,booking_id:t,amount:s,description:n}=r,{data:a}=await p.N.from("customers").select("name, email").eq("id",e).single(),o=null;if(t){let{data:e}=await p.N.from("bookings").select("service, date").eq("id",t).single();o=e}if(!a)return i.NextResponse.json({error:"Customer not found"},{status:404});let{data:c,error:d}=await p.N.from("payments").insert([{booking_id:t||null,customer_id:e,amount:s,payment_method:"card",payment_status:"pending",payment_date:new Date().toISOString().split("T")[0],reference:null,notes:"Stripe Checkout Session created"}]).select().single();if(d)return console.error("Error creating payment record:",d),i.NextResponse.json({error:"Failed to create payment record"},{status:500});let l="http://localhost:3000",m=n||(o?`Payment for ${o.service}`:"Service Payment"),y=await u._4.checkout.sessions.create({payment_method_types:["card"],line_items:[{price_data:{currency:"gbp",product_data:{name:m,description:o?`Service: ${o.service} | Date: ${o.date}`:"Payment for services"},unit_amount:Math.round(100*s)},quantity:1}],mode:"payment",success_url:`${l}/payment/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${l}/payment/cancel?payment_id=${c.id}`,customer_email:a.email,metadata:{customer_id:e,booking_id:t||"",payment_id:c.id,customer_name:a.name},expires_at:Math.floor(Date.now()/1e3)+86400});return await p.N.from("payments").update({reference:y.id,notes:`Stripe Checkout Session: ${y.id}`}).eq("id",c.id),i.NextResponse.json({payment:{...c,reference:y.id},checkout_url:y.url,session_id:y.id,expires_at:y.expires_at},{status:201})}{let e={...r,payment_status:r.payment_status||"paid"},{data:t,error:s}=await p.N.from("payments").insert([e]).select().single();if(s)return console.error("Error creating payment:",s),i.NextResponse.json({error:"Failed to create payment"},{status:500});return i.NextResponse.json({payment:t},{status:201})}}catch(e){return console.error("Unexpected error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}async function l(e){try{let{session_id:t,payment_intent_id:r,status:s,payment_method:n}=await e.json(),a=null;if(t){let{data:e,error:r}=await p.N.from("payments").select("*").eq("reference",t).single();!r&&e&&(a=e)}else if(r){let{data:e,error:t}=await p.N.from("payments").select("*").eq("reference",r).single();!t&&e&&(a=e)}if(!a)return i.NextResponse.json({error:"Payment not found"},{status:404});let o=u.qF[s]||"pending",{data:c,error:d}=await p.N.from("payments").update({payment_status:o,payment_method:n||a.payment_method,updated_at:new Date().toISOString()}).eq("id",a.id).select().single();if(d)return console.error("Error updating payment:",d),i.NextResponse.json({error:"Failed to update payment"},{status:500});return i.NextResponse.json({payment:c})}catch(e){return console.error("Unexpected error:",e),i.NextResponse.json({error:"Internal server error"},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/payments/route",pathname:"/api/payments",filename:"route",bundlePath:"app/api/payments/route"},resolvedPagePath:"/Users/ivanivanov/Documents/Projects/Plumbe-2/app/api/payments/route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:x,serverHooks:_}=m;function f(){return(0,o.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:x})}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[447,928,449],()=>r(74292));module.exports=s})();